name: Bing Daily Check-in

on:
  schedule:
    # 每天凌晨2点执行（UTC时间，对应北京时间10点）
    - cron: '0 2 * * *'
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]

jobs:
  bing-checkin:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 设置5小时超时
    env:
      PYTHONUNBUFFERED: 1  # 确保Python输出不被缓存
      DISPLAY: :99  # 为无头模式设置显示
      CHROME_BIN: /usr/bin/google-chrome  # Chrome路径
      CHROMEDRIVER_PATH: /usr/local/bin/chromedriver  # ChromeDriver路径
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Chrome 138 and ChromeDriver 138
      run: |
        set -eux
        CHROME_VERSION=138.0.7204.0
    
        wget -q https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chrome-linux64.zip
        unzip chrome-linux64.zip
        sudo mv chrome-linux64 /opt/chrome138
    
        wget -q https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip
        unzip chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
        sudo chmod +x /usr/local/bin/chromedriver
    
        /opt/chrome138/chrome --version
        chromedriver --version
    

        
    - name: Verify Chrome and ChromeDriver
      run: |
        google-chrome --version
        which google-chrome
        chromedriver --version
        which chromedriver
        echo "Chrome binary: $CHROME_BIN"
        echo "ChromeDriver path: $CHROMEDRIVER_PATH"
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create config directory
      run: mkdir -p config
      
    - name: Setup accounts configuration
      run: |
        # 从GitHub Secrets读取账号配置
        echo '${{ secrets.ACCOUNTS_CONFIG }}' > config/accounts.json
        
    - name: Run Bing automation
      run: |
        python bingZDH.py --once
        
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bing-logs
        path: |
          *.log
          *.png
        retention-days: 7
